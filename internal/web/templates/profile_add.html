{{template "layout" .}}

{{define "content"}}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 dark:text-white sm:text-3xl sm:truncate">
                Add Profile
            </h2>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Create a new GitHub authentication profile
            </p>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <form id="profile-form" hx-post="/api/profiles" hx-swap="none">
                <div class="space-y-6">
                    <!-- Profile name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Profile Name
                        </label>
                        <div class="mt-1">
                            <input type="text" name="name" id="name" required
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                                placeholder="e.g., work, personal, enterprise">
                        </div>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">A unique identifier for this profile</p>
                    </div>

                    <!-- Workspace -->
                    <div>
                        <label for="workspace" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Workspace
                        </label>
                        <div class="mt-1">
                            <select name="workspace" id="workspace" required
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                                <option value="">Select a workspace</option>
                                {{range .Workspaces}}
                                <option value="{{.Name}}">{{.Name}} ({{.Path}})</option>
                                {{end}}
                            </select>
                        </div>
                        {{if not .Workspaces}}
                        <p class="mt-2 text-sm text-red-500 dark:text-red-400">
                            No workspaces found. <a href="/workspaces" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">Create one first</a>.
                        </p>
                        {{end}}
                    </div>

                    <!-- GitHub host -->
                    <div>
                        <label for="host" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            GitHub Host
                        </label>
                        <div class="mt-1">
                            <input type="text" name="host" id="host" value="github.com"
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                                placeholder="github.com">
                        </div>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Use github.com for public GitHub, or your enterprise URL</p>
                    </div>

                    <!-- Authentication method -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                            Authentication Method
                        </label>
                        <div class="space-y-4">
                            <!-- PAT option -->
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="auth-pat" name="auth-method" type="radio" value="pat" checked
                                        class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                                        onchange="toggleAuthMethod('pat')">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="auth-pat" class="font-medium text-gray-700 dark:text-gray-300">Personal Access Token (PAT)</label>
                                    <p class="text-gray-500 dark:text-gray-400">Use an existing token from GitHub Settings</p>
                                </div>
                            </div>

                            <!-- OAuth option -->
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="auth-oauth" name="auth-method" type="radio" value="oauth"
                                        class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700"
                                        onchange="toggleAuthMethod('oauth')">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="auth-oauth" class="font-medium text-gray-700 dark:text-gray-300">OAuth Device Flow</label>
                                    <p class="text-gray-500 dark:text-gray-400">Authorize via browser (more secure)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PAT input -->
                    <div id="pat-section">
                        <label for="token" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            Personal Access Token
                        </label>
                        <div class="mt-1">
                            <input type="password" name="token" id="token"
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
                                placeholder="ghp_xxxxxxxxxxxx">
                        </div>
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <a href="https://github.com/settings/tokens/new" target="_blank" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                                Create a new token
                            </a>
                            with scopes: repo, read:org, gist, read:user, user:email
                        </p>
                    </div>

                    <!-- OAuth section (hidden by default) -->
                    <div id="oauth-section" class="hidden">
                        <div class="rounded-md bg-blue-50 dark:bg-blue-900/50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">OAuth Device Flow</h3>
                                    <div class="mt-2 text-sm text-blue-700 dark:text-blue-300">
                                        <p>Click "Start OAuth" to begin the authentication flow. You'll receive a code to enter at GitHub.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="oauth-status" class="mt-4"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-6 flex items-center justify-end space-x-3">
                    <a href="/profiles" class="bg-white dark:bg-gray-700 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </a>
                    <button type="submit" id="submit-btn"
                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span class="htmx-indicator mr-2">
                            <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        Create Profile
                    </button>
                    <button type="button" id="oauth-btn" class="hidden inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        onclick="startOAuth()">
                        Start OAuth
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleAuthMethod(method) {
    const patSection = document.getElementById('pat-section');
    const oauthSection = document.getElementById('oauth-section');
    const submitBtn = document.getElementById('submit-btn');
    const oauthBtn = document.getElementById('oauth-btn');
    const tokenInput = document.getElementById('token');

    if (method === 'pat') {
        patSection.classList.remove('hidden');
        oauthSection.classList.add('hidden');
        submitBtn.classList.remove('hidden');
        oauthBtn.classList.add('hidden');
        tokenInput.required = true;
    } else {
        patSection.classList.add('hidden');
        oauthSection.classList.remove('hidden');
        submitBtn.classList.add('hidden');
        oauthBtn.classList.remove('hidden');
        tokenInput.required = false;
    }
}

let oauthPollInterval = null;

function startOAuth() {
    const name = document.getElementById('name').value;
    const workspace = document.getElementById('workspace').value;
    const host = document.getElementById('host').value || 'github.com';

    if (!name || !workspace) {
        alert('Please fill in profile name and workspace first');
        return;
    }

    const statusDiv = document.getElementById('oauth-status');
    statusDiv.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400">Starting OAuth flow...</div>';

    fetch(`/oauth/github/start?name=${encodeURIComponent(name)}&workspace=${encodeURIComponent(workspace)}&host=${encodeURIComponent(host)}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                statusDiv.innerHTML = `<div class="text-sm text-red-500 dark:text-red-400">Error: ${data.error}</div>`;
                return;
            }

            if (data.status === 'waiting' || data.status === 'pending') {
                if (data.user_code) {
                    statusDiv.innerHTML = `
                        <div class="rounded-md bg-green-50 dark:bg-green-900/50 p-4">
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-800 dark:text-green-200 mb-2">Enter this code at GitHub:</p>
                                <p class="text-3xl font-bold text-green-900 dark:text-green-100 font-mono tracking-wider">${data.user_code}</p>
                                <p class="mt-3 text-sm text-green-700 dark:text-green-300">
                                    <a href="${data.verify_url}" target="_blank" class="underline">Open GitHub</a>
                                </p>
                                <p class="mt-2 text-xs text-green-600 dark:text-green-400">Waiting for authorization...</p>
                            </div>
                        </div>
                    `;
                }
                pollOAuthStatus(name);
            }
        })
        .catch(err => {
            statusDiv.innerHTML = `<div class="text-sm text-red-500 dark:text-red-400">Error: ${err.message}</div>`;
        });
}

function pollOAuthStatus(name) {
    if (oauthPollInterval) {
        clearInterval(oauthPollInterval);
    }

    oauthPollInterval = setInterval(() => {
        fetch(`/oauth/github/status?name=${encodeURIComponent(name)}`)
            .then(r => r.json())
            .then(data => {
                const statusDiv = document.getElementById('oauth-status');

                if (data.status === 'completed') {
                    clearInterval(oauthPollInterval);
                    statusDiv.innerHTML = `
                        <div class="rounded-md bg-green-50 dark:bg-green-900/50 p-4">
                            <div class="text-center">
                                <p class="text-sm font-medium text-green-800 dark:text-green-200">Success!</p>
                                <p class="text-sm text-green-700 dark:text-green-300">Profile created for ${data.username}</p>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = '/profiles';
                    }, 1500);
                } else if (data.status === 'error') {
                    clearInterval(oauthPollInterval);
                    statusDiv.innerHTML = `<div class="text-sm text-red-500 dark:text-red-400">Error: ${data.error}</div>`;
                }
            })
            .catch(() => {
                // Ignore polling errors
            });
    }, 2000);
}

// Handle form submission response
document.getElementById('profile-form').addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        // Redirect handled by HX-Redirect header
    } else {
        try {
            const response = JSON.parse(evt.detail.xhr.responseText);
            if (response.error) {
                alert('Error: ' + response.error);
            }
        } catch (e) {
            alert('An error occurred');
        }
    }
});
</script>
{{end}}
